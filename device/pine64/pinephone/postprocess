chroot "$OURDIR/$ROOTDIR" /usr/bin/systemctl enable getty@ttyS0.service
# Iwd works well on pinephone, might as well use it
chroot "$OURDIR/$ROOTDIR" rpm -e wpa_supplicant
cat >"$OURDIR/$ROOTDIR"/usr/lib/NetworkManager/conf.d/00-wifi-backend.conf <<EOF
[device]
wifi.backend=iwd
EOF
# FIXME workaround for pulseaudio nuking (>= 12.0) or garbling (<= 11.0)
# sound
sudo rpm -r "$OURDIR/$ROOTDIR" -e --nodeps pulseaudio pulseaudio-utils pulseaudio-module-x11 pulseaudio-client-config ${LIB}alsa-plugins-pulseaudio
# Disable some stuff pinephone doesn't use (but pulls in due to
# dependencies). Longer term, those dependencies should be eliminated
for i in mdmonitor rtkit-daemon remote-cryptsetup dnf-automatic-download \
		dnf-automatic-install dnf-automatic-notifyonly dnf-automatic \
		dnfdaemon dnf-makecache nscd; do
	chroot "$OURDIR/$ROOTDIR" /usr/bin/systemctl disable $i
done
# plasma-mobile likes numeric passwords
echo 'omv:1234' | chroot "$OURDIR/$ROOTDIR" /usr/sbin/chpasswd
# usb-gadget support is extremely useful for debugging
chroot "$OURDIR/$ROOTDIR" /usr/bin/systemctl enable usb-gadget
chroot "$OURDIR/$ROOTDIR" /usr/bin/systemctl enable plymouth-start
# phone functionality
chroot "$OURDIR/$ROOTDIR" /usr/bin/systemctl enable modem
chroot "$OURDIR/$ROOTDIR" /usr/bin/systemctl enable ModemManager

# Let's put the debug shell on something we stand a chance of seeing...
sed -i -e 's,tty9,ttyS0,g' "$OURDIR/$ROOTDIR"/lib/systemd/system/debug-shell.service
