#!/bin/sh

set -x

DEV="$1"
AYYA_SUPER_IMG="$2"

if [ "$(id -u)" != 0 ]; then
	echo "This script needs root access to write to the SD card"
	echo "directly, reload partition tables, etc."
	exec sudo $0 "$@"
	# Just in case sudo isn't installed
	exit 1
fi
MISSING=""
for tool in kpartx partx fdisk dd resize.f2fs eject; do
	if ! which $tool &>/dev/null; then
		MISSING="$MISSING $tool"
	fi
done
if [ -n "$MISSING" ]; then
	echo "You're missing some tools needed by this script:"
	echo "	$MISSING"
	echo "Please install the tools (or run the script from a live image that has them,"
	echo "such as OpenMandriva Cooker)."
	exit 1
fi

echo "WARNING: All data on $DEV will be overwritten. If you"
echo "aren't sure this is what you want to do, press Ctrl-C"
echo "now. Otherwise, press enter to continue."
read

if ! [ -e @BASENAME@.img ]; then
    xz -d @BASENAME@.img.xz
fi

losetup -fP @BASENAME@.img
LOOPDEV2=$(losetup -j @BASENAME@.img |tail -n1 |cut -d: -f1)
SD2="$(kpartx $LOOPDEV2 |tail -n1)"
PART2="$(echo $SD2 |cut -d' ' -f 1)"


dd if=/dev/$PART2 of=$DEV bs=1M status=progress


losetup -d $LOOPDEV2


# We need to mount the image to get it maked clean
rmdir mnt || :
mkdir mnt
mount -o loop $DEV mnt
umount mnt
rmdir mnt


simg2img $AYYA_SUPER_IMG tmp_super.img
mkdir tmp
lpdump tmp_super.img dump.txt
lpunpack tmp_super.img tmp

lpmake  --metadata-size  65536  \
  --super-name  super  --metadata-slots  3  \
  --virtual-ab  \
  --device  super:6442450944  \
  --group  main_a:6440353792  \
  --group  main_b:6440353792  \
  --partition  product_a:readonly:1811709952:main_a  \
  --image  product_a=tmp/product_a.img  \
  --partition  product_b:readonly:0:main_b  \
  --partition  vendor_a:readonly:524083712:main_a  \
  --image  vendor_a=tmp/vendor_a.img  \
  --partition  vendor_b:readonly:0:main_b  \
  --partition  system_a:readonly:2925527040:main_a  \
  --image  system_a=$DEV  \
  --sparse  \
  --output  ayya_pino_super.img

rm -rf tmp
